# Prerequisites to run a demo

- [Deno](https://docs.deno.com/runtime/getting_started/installation/) must already be installed on the machine to run the
  scripts in this package. Deno `v2.3.5` was used during development.
- Compiled Plutus scripts in a [_blueprint_ file](./onchain/plutus.json) generated by `Aiken` (`plutus.json`) must be present in
  subdirectory `./onchain` before running any script in this package that interacts with onchain components.

## Installing

```shell
git clone https://github.com/trustlevel/defi-lending-smart-contracts.git lending-protocol && \
cd lending-protocol && \
deno install --allow-scripts=npm:cbor-extract
```

For convenience &mdash; in case the on-chain components repo is not yet present in the project directory &mdash; also run the
following in order to get the latest `plutus.json` blueprint file:

```shell
# should be run from inside the `lending-protocol` project root:
cd onchain && \
aiken build
```

### Prep env vars

Copy the file `./.env_sample` into `./.env` and fill in required variables. [Kupo](https://cardanosolutions.github.io/kupo/) and [Ogmios](https://ogmios.dev/) endpoints can be conveniently taken from [Demeter.run](https://demeter.run/) services. [Blockfrost](https://blockfrost.dev) API key can be requested at [blockfrost.io](https://blockfrost.io).

For the seed phrases, it can be from any Cardano wallet app.

## Running

Be sure to have some `tADA` in each of the _admin_, _oracle provider_ and _user_ accounts before proceeding. For convenience, testnet faucet can be found [here](https://docs.cardano.org/cardano-testnets/tools/faucet).

Also check the wallet accounts provided in the `.env` file if there are multiple ADA-only utxos. If there's only one, create several ADA-only utxos before proceeding. One of these will be needed by the tx builder to be used as _collateral_ utxo in the txs for each account.

Following commands should be run from the project root directory (`lending-protocol/`):

#### Initialization

1. Initialize the protocol by minting the beacon tokens and deploying the validators as _reference scripts_.

   The settings utxos &mdash; global settings and oracle settings &mdash; go to the `settings` validator address

   ```shell
   # prep log and results data directory:
   mkdir -pv data

   # run deploy script and write output to file:
   deno task deploy-refscripts 2>&1 | tee data/deploy-results.log
   ```

   This deploy script submits 7 transactions. This splitting into multiple txs is necessary in order to stay within protocol size limit:

      1. Tx 1 mints the settings beacon tokens (`GCFG` and `OCFG`) and the audit beacon token (`AUDT`). It also initializes the settings utxos held at the `settings` contract address, and the audit utxo held at the `audit` contract address. ([sample tx](https://preprod.cardanoscan.io/transaction/e1aa4841f1ceed62d6779b38bf497c151ffe4193fa3157256fd38ef5977fc069?tab=utxo))

      2. Tx 2 deploys as _reference scripts_ the compiled validators for `refscripts` and `settings`. These utxos will be held at the `refscripts` contract address, and they will each come with their corresponding beacon tokens that are minted in the same tx. ([sample tx](https://preprod.cardanoscan.io/transaction/8f6eb6698abe755c0e2a9c9dfe1eac41104e7158c66646addfed76c1dc4cb68d?tab=utxo))
      
      3. Tx 3 deploys as _reference scripts_ the compiled validators for `oracle`, and `registry`. These utxos will likewise be held at the `refscripts` contract address, and they will each come with their corresponding beacon tokens that are minted in the same tx. ([sample tx](https://preprod.cardanoscan.io/transaction/1e88e0f3c10154f6281c3fa63f90be43895b0a9c2ea55f9bfe7d7dda74f6e21f?tab=utxo))

      4. Tx 4 deploys as _reference scripts_ the compiled validator for `collateral`. This utxo will likewise be held at the `refscripts` contract address, and it will ecome with its corresponding beacon token that is minted in the same tx. ([sample tx](https://preprod.cardanoscan.io/transaction/73ba8e35fc35a92e2b70e6cbf938bf670935a8dabfb3b6ec50d0b33527eb9829?tab=utxo))

      5. Tx 5 deploys as _reference scripts_ the compiled validator for `audit`. This utxo will likewise be held at the `refscripts` contract address, and it will ecome with its corresponding beacon token that is minted in the same tx. ([sample tx](https://preprod.cardanoscan.io/transaction/82a8e616ca782a450ef106b718346a46a4102b26b5aa809e8e1831dba25e2834?tab=utxo))

      6. Tx 6 deploys as _reference scripts_ the compiled validator for `lending_pool`. This utxo will likewise be held at the `refscripts` contract address, and it will come with its corresponding beacon token that is also minted in the same tx. ([sample tx](https://preprod.cardanoscan.io/transaction/2e18e915ebcc611ecf8fcdbc21d33563e5d631dc39c4af5f947fc90bcbc32fc8?tab=utxo))

      7. Tx 7 initializes the _oracle price utxo_ with the latest price quotation for the collateral asset. This utxo will be held at the `oracle` contract address, and it will also come with its corresponding beacon token (`OPRC`) that is minted in the same tx. ([sample tx](https://preprod.cardanoscan.io/transaction/52d46f9f2016a1a49aaf8dc57bf5cac4c093357cdd133fb4f539e429e42604b1?tab=utxo))   

2. Get some tUSDM to be used as the sample loanable asset. These are pre-minted tUSDM tokens that are locked at an `always_true` contract. **NOTE**: Skip this step if the admin acct already has the tUSDM tokens from previous script executions.

    These tUSDM tokens are the same assets that already has a [liquidity pool](https://testnet-preprod.minswap.org/swap?cA=&tA=&cB=11c93226aabf1e9157620857d9ac013ba111680bd837f62a7ca90214&tB=0014df10745553444d) created at Minswap (preprod). This is the trading pair that will be queried by the `oracle` component below, to update its price data.

    ```shell
    deno task get-loanable-tokens 2>&1 | tee data/get-loanable-tokens-results.log
    ```
    ([sample tx](https://preprod.cardanoscan.io/transaction/4693103cab4bb2db9029715cbcd8387a4333bd1c710a376dc205745d337cc7a5?tab=utxo))

3. When the _test_ loanable tokens arrive at the admin account, it can then be deposited into the `lending_pool` contract. The utxo on the `lending_pool` created by this tx also contains the lending pool's [initial settings](https://lending-aiken-docs.staking.rocks/types.html#LendingPoolDatum).

   ```shell
   deno task deposit-loanable-asset 2>&1 | tee data/deposit-loanable-asset-results.log
   ```
   ([sample tx](https://preprod.cardanoscan.io/transaction/3eb85a0c3860f20a66b8e9f4e96107ead95ad054504c3d0c4fc21d10e6c12821?tab=utxo))

4. Start the `oracle` price updater service. This needs to keep running in order to keep the oracle price datum updated. So, this should ideally be run in a separate terminal session. e.g. inside a `tmux` or `screen` process.

   ```shell
   deno task update-oracle-price 2>&1 | tee data/update-oracle-price-results.log
   ```
   ([sample tx]())

#### User Interaction

1. Deposit collateral asset (currently set to ADA):
   ```shell
   # user1:
   deno task deposit-collateral-user1 2>&1 | tee data/deposit-collateral-user1-results.log

   # user2:
   deno task deposit-collateral-user2 2>&1 | tee data/deposit-collateral-user2-results.log
   ```

   This creates a collateral utxo for the user, at the `collateral` contract address. The utxo will have the following datum:

   ```aiken
   // aiken
   CollateralDatum {
      owner: Address,
      collateral_asset: AssetClass,
      status: Available,
   }
   ```
   ([user1 sample tx](https://preprod.cardanoscan.io/transaction/97c714bc4a3a8f7283be52f37178288db3669a4433afa4b47f2032695e0c3d80?tab=utxo))

2. Borrow against collateral (this locks the collateral):
   ```shell
   # user1:
   deno task borrow-user1 2>&1 | tee data/borrow-user1-results.log

   # user2:
   deno task borrow-user2 2>&1 | tee data/borrow-user2-results.log
   ```

   This script creates 2 txs - the 1st one simulating the user's request to take a loan, and the 2nd one chained to the 1st is simulating the admin/backend's loan request fulfillment action.

   The first tx (user's action) updates the collateral utxo datum to the following:
   ```aiken
   // aiken
   CollateralDatum {
      owner: Address,
      collateral_asset: AssetClass,
      status: LoanRequested {
         request: LoanRequest {
            borrowed_asset: AssetClass,
            borrowed_amt: Int,
            loan_term: Int
         }
      }
   }
   ```
   ([user1 sample tx](https://preprod.cardanoscan.io/transaction/a83ebbc3ad94e4a1de53fa526fb859ae01e409cde031245ff3d4d35265f762c2?tab=utxo))

   The second tx (admin's action) spends from the `lending_pool` contract and sends the borrowed asset to the user's address and updates the collateral utxo datum to the following:
   ```aiken
   // aiken
   CollateralDatum {
      owner: Address,
      collateral_asset: AssetClass,
      status: LoanIssued,
   }
   ```

   This locks the collateral utxo and it cannot be withdrawn by its owner.

   Another utxo is created at the `position_registry` contract which contains the loan metadata in its datum:
   ```aiken
   // aiken
   PositionRegistryDatum {
      borrower: Address,
      loan: LoanDatum {
         collateral_asset: AssetClass,
         borrowed_asset: AssetClass,
         collateral_amt: Int,
         borrowed_amt: Int,
         interest_amt: Int,
         loan_term: Int,
         maturity: PosixTime
      }
      liquidator: None
   }
   ```

   A unique pair of _position tokens_ is minted during this second tx. One of these tokens goes with the _collateral_ utxo, and the other goes with the _position_ utxo. They are used to link together the 2 related utxos.

   ([sample tx](https://preprod.cardanoscan.io/transaction/e5dfa4537cc3eb764a8fabb08675d27095a6adaa5bddc0fbfceefbfebc10f339?tab=utxo))

   **In case of error on 2nd tx:**

   In case of error on the 2nd tx above, it can be useful to reset the `LoanRequested` status of the collateral UTXO that has
   been applied during the 1st tx. To reset it back to its previous `Available` status:

   ```shell
   # user1
   deno task reset-borrow-req-user1 2>&1 | tee data/reset-borrow-req-user1-results.log

   # user2
   deno task reset-borrow-req-user2 2>&1 | tee data/reset-borrow-req-user2-results.log
   ```

3. Repay borrowed asset (this unlocks collateral):
   ```shell
   # user1
   deno task repay-user1 2>&1 | tee data/repay-user1-results.log

   # user2
   deno task repay-user2 2>&1 | tee data/repay-user2-results.log
   ```
   This script creates 2 txs - the 1st one simulating the user's request to repay their loan, and the 2nd one chained to the 1st is simulating the admin/backend's repayment request fulfillment action.

   The first tx (user's action) updates the collateral utxo to now also contain the repayment asset, and its datum is changed to the following:
   ```aiken
   // aiken
   CollateralDatum {
      owner: Address,
      collateral_asset: AssetClass,
      status: RepayRequested,
   }
   ```

   The second tx (admin's action) sends the repayment asset (principal + interest) back to the `lending_pool` contract and
   updates the collateral utxo datum back to the following (unlocked state):

   ```aiken
   // aiken
   CollateralDatum {
      owner: Address,
      collateral_asset: AssetClass,
      status: Available,
   }
   ```

   The pair of _position tokens_ used to identify the loan position is also burned in this second tx, and the _position utxo_ is removed from the `position_registry` contract.


4. Withdraw unlocked/available collateral:

   ```shell
   # user1
   deno task withdraw-collateral-user1 2>&1 | tee data/withdraw-collateral-user1-results.log

   # user2
   deno task withdraw-collateral-user2 2>&1 | tee data/withdraw-collateral-user2-results.log
   ```

#### Admin actions

1. List open loan positions
   ```shell
   deno task list-loan-positions
   ```

2. Update the `audit` UTXO datum

   ```shell
   deno task audit 2>&1 | tee data/audit-update-results.log
   ```

   This updates the `audit` utxo datum that contains the protocol's overall health score, among other items. To view, the contents of the current `audit` utxo, run:

   ```shell
   deno task audit-view
   ```

3. Liquidate a position that is either overdue, or undercollateralized:

   ```shell
   deno task liquidate-position 2>&1 | tee data/liquidate-results.log
   ```

   This script checks all open loan positions (from the `registry` utxos) to find one that is eligible for liquidation. If it finds one, it then creates a market order at Minswap, selling the collateral asset for the borrowed asset.

   The recipient set in the swap order to receive the proceeds, is the collateral contract. So the liquidation proceeds just goes back to the collateral contract address for now. The next part (still to be implemented), is to spend that swapped asset in the collateral contract, to repay the loan, and the remainder can be taken by the liquidator.

   ([liquidation sample tx](https://preprod.cardanoscan.io/transaction/93904e2b3de6aff1db34868bffea9ff3275d276057e99a0db9689354c82e6c92?tab=utxo))

   ([executed swap sample tx](https://preprod.cardanoscan.io/transaction/9ef2a35bb8c5a16b3a6e5fa9f333695416d73f0966ed92129c0da278fddf4442?tab=utxo))

4. Withdraw loanable assets from the `lending_pool` contract (for when decommissioning):
   ```shell
   deno task withdraw-loanable-asset 2>&1 | tee data/withdraw-loanable-asset-results.log
   ```
   
   ([sample tx](https://preprod.cardanoscan.io/transaction/2ab6e564806afd2ce2aca4399e29440b4e4e5fbb6a365c643bfc6e8d78979dd2?tab=utxo))

5. Undeploy refscripts (for when decommissioning):
   ```shell
   deno task undeploy-refscripts 2>&1 | tee data/undeploy-results.log
   ```
   This burns the beacon tokens and spends the utxos in the `refscripts` contract.

   ([part1 sample tx](https://preprod.cardanoscan.io/transaction/6bdc6cc34c1051c1aaf526714b22f6af22170939cb61e4c1e688fc6bbfccd580?tab=utxo))
   
   ([part2 sample tx](https://preprod.cardanoscan.io/transaction/9a672bd0db93525eb60ea2bb73a3164bd7e796cf3bd45b04fc9ac68bd6c3ec42?tab=utxo))

   ([part3 sample tx](https://preprod.cardanoscan.io/transaction/bc86f5eb5258ed4ecf13571304e076e02149bc3518c7379daf2439e94ac92fff?tab=utxo))